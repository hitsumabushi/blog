
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://www.hitsumabushi.org/theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="https://www.hitsumabushi.org/theme/pygments/monokai.min.css">

    <link rel="stylesheet" href="https://www.hitsumabushi.org/theme/tipuesearch/tipuesearch.min.css" />

  <link rel="stylesheet" type="text/css" href="https://www.hitsumabushi.org/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://www.hitsumabushi.org/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://www.hitsumabushi.org/theme/font-awesome/css/solid.css">

    <link rel="stylesheet" type="text/css" href="https://www.hitsumabushi.org/static/custom.css">

    <link href="https://www.hitsumabushi.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="ひつまぶし食べたい Atom">


    <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">

  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JPYFS3RY30"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JPYFS3RY30');
</script>
<!-- End of Global site tag (gtag.js) - Google Analytics -->

 

<meta name="author" content="hitsumabushi" />
<meta name="description" content="最近、VMwareのESXiで仮想環境を作っています。 触っていて気づいたのですが、空の仮想マシンを起動するとPXEブートを試みてくれます。 この仕様をうまく使いたいなーと思って、PXEブートでインストールを自動化する方法を調べました。 PXEブートしてインストールを自動化するまでの手順を簡単に書いていきます。 Debianをインストールサーバーとして予め立 …" />
<meta name="keywords" content="pxe, preseed, kickstart">


  <meta property="og:site_name" content="ひつまぶし食べたい"/>
  <meta property="og:title" content="PXEブートでインストーラを起動する"/>
  <meta property="og:description" content="最近、VMwareのESXiで仮想環境を作っています。 触っていて気づいたのですが、空の仮想マシンを起動するとPXEブートを試みてくれます。 この仕様をうまく使いたいなーと思って、PXEブートでインストールを自動化する方法を調べました。 PXEブートしてインストールを自動化するまでの手順を簡単に書いていきます。 Debianをインストールサーバーとして予め立 …"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://www.hitsumabushi.org/blog/2014/01/01/0244.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2014-01-01 02:44:20+09:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="https://www.hitsumabushi.org/author/hitsumabushi.html">
  <meta property="article:section" content="blog"/>
  <meta property="article:tag" content="pxe"/>
  <meta property="article:tag" content="preseed"/>
  <meta property="article:tag" content="kickstart"/>
  <meta property="og:image" content="/static/profile.jpg">

  <title>ひつまぶし食べたい &ndash; PXEブートでインストーラを起動する</title>

</head>
<body class="light-theme">
  <aside>
    <div>
      <a href="https://www.hitsumabushi.org/">
        <img src="/static/profile.jpg" alt="" title="">
      </a>

      <h1>
        <a href="https://www.hitsumabushi.org/"></a>
      </h1>

<p>メモ代わりのブログ</p>
        <form class="navbar-search" action="https://www.hitsumabushi.org/search.html" role="search">
          <input type="text" name="q" id="tipue_search_input" placeholder="Search...">
        </form>


      <ul class="social">
          <li>
            <a  class="sc-twitter" href="https://twitter.com/_hitsumabushi_" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-github" href="https://github.com/hitsumabushi" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="https://www.hitsumabushi.org/">Home</a>

      <a href="/archives.html">Archives</a>

      <a href="https://www.hitsumabushi.org/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="pxebutodeinsutorawoqi-dong-suru">PXEブートでインストーラを起動する</h1>
    <p>
      Posted on Wed 01 January 2014 in <a href="https://www.hitsumabushi.org/category/blog.html">blog</a>

    </p>
  </header>


  <div>

    <div class="content">
      <div class="line-block">
<div class="line">最近、VMwareのESXiで仮想環境を作っています。</div>
<div class="line">触っていて気づいたのですが、空の仮想マシンを起動するとPXEブートを試みてくれます。</div>
<div class="line">この仕様をうまく使いたいなーと思って、PXEブートでインストールを自動化する方法を調べました。</div>
</div>
<div class="line-block">
<div class="line">PXEブートしてインストールを自動化するまでの手順を簡単に書いていきます。</div>
<div class="line">Debianをインストールサーバーとして予め立てておき、DebianまたはCentOSをインストールすることにします。</div>
</div>
<div class="contents local topic" id="id1">
<ul class="simple">
<li><a class="reference internal" href="#debian-install" id="id12">1. Debian Install</a></li>
<li><a class="reference internal" href="#dhcp" id="id13">2. DHCPサーバーを立てる</a></li>
<li><a class="reference internal" href="#tftp" id="id14">3. TFTPサーバーを立てる</a></li>
<li><a class="reference internal" href="#id2" id="id15">4. PXEブート用のイメージを準備する</a></li>
<li><a class="reference internal" href="#id3" id="id16">5. 中間チェック</a><ul>
<li><a class="reference internal" href="#os" id="id17">ブート画面でOSを選択できるようにする</a></li>
</ul>
</li>
<li><a class="reference internal" href="#centos" id="id18">6. CentOSのインストーラを準備</a></li>
<li><a class="reference internal" href="#id4" id="id19">7. メニューの作成</a><ul>
<li><a class="reference internal" href="#debian" id="id20">Debianインストールの自動化</a></li>
</ul>
</li>
<li><a class="reference internal" href="#preseed" id="id21">8. preseed ファイル作成</a></li>
<li><a class="reference internal" href="#pxelinux-cfg-default" id="id22">9. pxelinux.cfg/default 書き換え</a></li>
<li><a class="reference internal" href="#id6" id="id23">10. Debianインストールのチェック</a><ul>
<li><a class="reference internal" href="#cent-os" id="id24">Cent OSインストールの自動化</a></li>
</ul>
</li>
<li><a class="reference internal" href="#http" id="id25">11. httpサーバー作成</a></li>
<li><a class="reference internal" href="#id7" id="id26">12. CentOSイメージのマウント</a></li>
<li><a class="reference internal" href="#kickstart" id="id27">13. kickstartファイルの準備</a></li>
<li><a class="reference internal" href="#id8" id="id28">14. kickstartファイルの配置</a></li>
<li><a class="reference internal" href="#id9" id="id29">15. CentOSインストールのチェック</a><ul>
<li><a class="reference internal" href="#id10" id="id30">もっと自動化できるけど...</a></li>
<li><a class="reference internal" href="#id11" id="id31">さらに読もうと思ってるサイト</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="debian-install">
<h2>1. Debian Install</h2>
<div class="line-block">
<div class="line">最初のDebianはCDやらで手動でインストールしてください。</div>
<div class="line">Debianのインストール手順は省略します。</div>
</div>
</div>
<div class="section" id="dhcp">
<h2>2. DHCPサーバーを立てる</h2>
<div class="highlight"><pre><span></span><span class="c1"># Install DHCP Server</span>
apt-get<span class="w"> </span>install<span class="w"> </span>isc-dhcp-server

<span class="c1"># Config DHCP : INTERFACES</span>
vi<span class="w"> </span>/etc/default/isc-dhcp-server
<span class="c1"># Modify INTERFACES=&quot;&quot; to INTERFACES &quot;eth1&quot;</span>

<span class="c1"># Config DHCP : Server setting</span>
vi<span class="w"> </span>/etc/dhcp/dhcpd.conf
</pre></div>
<p>編集する箇所は以下の通りです。</p>
<p><a class="reference external" href="https://gist.github.com/10664868">https://gist.github.com/10664868</a></p>
<p>DHCPサーバーを再起動して設定を反映させます。</p>
<div class="highlight"><pre><span></span><span class="c1"># Restart DHCP Server</span>
/etc/init.d/isc-dhcp-server<span class="w"> </span>restart
</pre></div>
</div>
<div class="section" id="tftp">
<h2>3. TFTPサーバーを立てる</h2>
<p>デフォルトで大丈夫でした。</p>
<div class="highlight"><pre><span></span><span class="c1"># Install TFTP Server</span>
apt-get<span class="w"> </span>install<span class="w"> </span>tftpd-hpa
</pre></div>
</div>
<div class="section" id="id2">
<h2>4. PXEブート用のイメージを準備する</h2>
<p>以下のページから適当にnetbootイメージを選んで、netboot/netboot.tar.gzを取って来ます。</p>
<ul class="simple">
<li><a class="reference external" href="http://www.debian.org/distrib/netinst#netboot">http://www.debian.org/distrib/netinst#netboot</a></li>
</ul>
<div class="highlight"><pre><span></span><span class="c1"># 展開する</span>
tar<span class="w"> </span>xvf<span class="w"> </span>netboot.tar.gz
<span class="c1"># move files to root dir of TFTP</span>
mv<span class="w"> </span>./*<span class="w"> </span>/srv/tftp
</pre></div>
</div>
<div class="section" id="id3">
<h2>5. 中間チェック</h2>
<p>この段階でPXEブートしてみると、Debianのインストーラが立ち上がるようになります。</p>
<div class="section" id="os">
<h3>ブート画面でOSを選択できるようにする</h3>
</div>
</div>
<div class="section" id="centos">
<h2>6. CentOSのインストーラを準備</h2>
<ol class="arabic simple">
<li>mkdir -p /srv/tftp/centos/6.5/x86_64</li>
<li>CentOSのインストールDVDを持って来る</li>
<li>mount -o loop &lt;CentOS install ISO&gt; /media</li>
<li><dl class="first docutils">
<dt>/media/images/pxeboot/にある次の2つのファイルを/srv/tftp/centos/6.5/x86_64/以下にコピーしてくる</dt>
<dd><ul class="first last">
<li>initrd.img</li>
<li>vmlinuz</li>
</ul>
</dd>
</dl>
</li>
<li>umount /media</li>
</ol>
<p>ここで、Debianのインストーラたちも整理して、
/srv/tftp/debian/7.4/amd64 以下にあるとします。:</p>
<pre class="literal-block">
/srv/tftp/
        |
        |-debian/7.4/amd64/
        |       |
        |       |-boot-screens
        |       |
        |       |-initrd.gz
        |       |
        |       |-linux
        |       |
        |       |-pxelinux.0
        |       |
        |       |-pxelinux.cfg/default
        |
        |-centos/6.5/x86_64
        |       |
        |       |-initrd.img
        |       |
        |       |-vmlinuz
        |
        |-pxelinux.0 -(シンボリックリンク)-&gt; debian/7.4/amd64/pxelinux.0
        |
        |-pxelinux.cfg -(シンボリックリンク)-&gt; debian/7.4/amd64/pxelinux.cfg
</pre>
</div>
<div class="section" id="id4">
<h2>7. メニューの作成</h2>
<p>pxelinux.cfg/defaultの内容を以下のように編集します。
後でもう少し修正します。
<a class="reference external" href="https://gist.github.com/10663699">最終形はGistにあがっているので</a>、 そちらを見てください。</p>
<div class="highlight"><pre><span></span><span class="c1"># D-I config version 2.0</span>
default<span class="w"> </span>debian/7.4/amd64/boot-screens/vesamenu.c32

<span class="c1"># Boot Menuに入りたい</span>
prompt<span class="w"> </span><span class="m">1</span>
timeout<span class="w"> </span><span class="m">300</span>
menu<span class="w"> </span>title<span class="w"> </span>-<span class="w"> </span>Boop<span class="w"> </span>Options<span class="w"> </span>Menu<span class="w"> </span>-

label<span class="w"> </span>Debian-7.4
menu<span class="w"> </span>label<span class="w"> </span>^0<span class="w"> </span>Debian<span class="w"> </span><span class="m">7</span>.4
<span class="c1">#include debian/7.4/amd64/boot-screens/menu.cfg</span>
kernel<span class="w"> </span>debian/7.4/amd64/linux
append<span class="w"> </span><span class="nv">priority</span><span class="o">=</span>critical<span class="w"> </span><span class="nv">vga</span><span class="o">=</span><span class="m">788</span><span class="w"> </span><span class="nv">initrd</span><span class="o">=</span>debian/7.4/amd64/initrd.gz

label<span class="w"> </span>CentOS-6.5
menu<span class="w"> </span>label<span class="w"> </span>^1<span class="w"> </span>CentOS<span class="w"> </span><span class="m">6</span>.5
kernel<span class="w"> </span>centos/6.5/x86_64/vmlinuz
append<span class="w"> </span><span class="nv">initrd</span><span class="o">=</span>centos/6.5/x86_64/initrd.img
</pre></div>
<div class="section" id="debian">
<h3>Debianインストールの自動化</h3>
<div class="line-block">
<div class="line">ここまでで、PXEブートさえしていれば、複数のOSを選んでインストールできるようになりました。</div>
<div class="line">いまのところの問題点としては、結局インストーラを起動した後は手作業になっていることです。</div>
<div class="line">次は、PXEブートした後、放っておくと勝手にインストールが終わっているようにしましょう。</div>
</div>
<div class="line-block">
<div class="line">Debianの場合にこれを実現するには、preseedと呼ばれる設定ファイルを書けば良いです。</div>
<div class="line">普通にインストールするときに色々な質問に答える必要があると思いますが、その答えを事前に書いておくものです。</div>
<div class="line">ただ、preseedが読まれる前に、インストーラから質問される(インストールのタイプなど)ことがあるので、そのあたりはブート時のパラメータとして渡しましょう。</div>
</div>
</div>
</div>
<div class="section" id="preseed">
<h2>8. preseed ファイル作成</h2>
<div class="line-block">
<div class="line">preseedファイルはかなり長いです。</div>
<div class="line">昔はpreseedのドキュメントを読んでも、作るの大変だった印象があったのですが、<a class="reference external" href="https://www.debian.org/releases/wheezy/example-preseed.txt">コメント付きのpreseedの例がある</a> ので、これを元に書いて行けば特に大きくは困らないです。</div>
<div class="line">ただ、例に書かれていないのですが、GRUBの設定を追加しないといけないのはわかりづらいかも知れません。</div>
<div class="line">preseedで細かく設定しようとすると大変なので、それはAnsibleなどインストール終わってからの自動化に入れる方針です。</div>
</div>
<div class="line-block">
<div class="line">今回はパーティションなどは全部インストーラに任せています。</div>
<div class="line">パーティションを変える場合などは、コメントアウトされているところを変更してください。</div>
</div>
<p><a class="reference external" href="https://gist.github.com/10664868">https://gist.github.com/10664868</a> の preseed.cfgを参照。</p>
</div>
<div class="section" id="pxelinux-cfg-default">
<h2>9. pxelinux.cfg/default 書き換え</h2>
<div class="line-block">
<div class="line">今書いたpreseedファイルを debian/7.4/preseed.cfg として配置したことにします。</div>
<div class="line">ブートオプションなどを追加した pxelinux.cfg/default ファイルは以下のようになります。</div>
</div>
<div class="line-block">
<div class="line">あとでどうせCentOSも自動化するので、そちらもあわせてオプションをつけておきます。</div>
</div>
<p><a class="reference external" href="https://gist.github.com/10664868">https://gist.github.com/10664868</a> の defaultを参照。</p>
</div>
<div class="section" id="id6">
<h2>10. Debianインストールのチェック</h2>
<div class="line-block">
<div class="line">また実際にPXEブートしてみましょう。</div>
<div class="line">Debianをメニューで選択すると、今度は勝手に画面が進んで行くと思います。</div>
<div class="line">最後までインストールが終わり、勝手にリブートされてこれば、成功です。s</div>
</div>
<div class="section" id="cent-os">
<h3>Cent OSインストールの自動化</h3>
</div>
</div>
<div class="section" id="http">
<h2>11. httpサーバー作成</h2>
<div class="line-block">
<div class="line">後でやるように、kickstartファイルはhttp経由で配ろうと思います。(TFTPでできないっぽかった)</div>
<div class="line">なので、httpサーバーを予め立てておくことにします。</div>
</div>
<div class="highlight"><pre><span></span><span class="c1"># apache install</span>
apt-get<span class="w"> </span>install<span class="w"> </span>apache2
</pre></div>
</div>
<div class="section" id="id7">
<h2>12. CentOSイメージのマウント</h2>
<div class="highlight"><pre><span></span>mkdir<span class="w"> </span>-p<span class="w"> </span>/var/www/images/centos
mount<span class="w"> </span>-o<span class="w"> </span>loop<span class="w"> </span>&lt;CentOS<span class="w"> </span>install<span class="w"> </span>ISO&gt;<span class="w"> </span>/var/www/images/centos
</pre></div>
</div>
<div class="section" id="kickstart">
<h2>13. kickstartファイルの準備</h2>
<p>kickstartファイルの詳細については、
<a class="reference external" href="https://access.redhat.com/site/documentation/ja-JP/Red_Hat_Enterprise_Linux/6/html/Installation_Guide/s1-kickstart2-options.html">redhatのページ</a>
が参考になります。というか、コレ見たら大体で書ける。</p>
<p>今回使っているkickstartfileは以下の通りです。</p>
<p><a class="reference external" href="https://gist.github.com/10664868">https://gist.github.com/10664868</a> の kickstart.cfgを参照。</p>
</div>
<div class="section" id="id8">
<h2>14. kickstartファイルの配置</h2>
<div class="line-block">
<div class="line">pxelinux.cfg/defaultファイルの内容に合わせて、kickstart.cfgを配置します。</div>
<div class="line">今回は、apacheのドキュメントルート直下に置けば良いようにしました。</div>
</div>
<div class="highlight"><pre><span></span>mv<span class="w"> </span>kickstart.cfg<span class="w"> </span>/var/www/
</pre></div>
</div>
<div class="section" id="id9">
<h2>15. CentOSインストールのチェック</h2>
<div class="line-block">
<div class="line">最後に、CentOSのインストールを確かめます。</div>
<div class="line">実際にPXEブートして、CentOSをメニューで選択すると、勝手に画面が進んで行くと思います。</div>
<div class="line">最後までインストールが終わり、勝手にリブートされてこれば、成功です。</div>
</div>
<div class="section" id="id10">
<h3>もっと自動化できるけど...</h3>
<div class="line-block">
<div class="line">今回は、インストールの自動化を行いました。</div>
<div class="line">一応、インストールするOSの種類を選ぶところを手でやることにしましたが、普通はOSは一種類で良いか、MACアドレスでインストールするOSを分けてしまうのだと思います。</div>
<div class="line">そうしておけば、OSの種類を選ぶところも自動化することができます。</div>
<div class="line">自分としては、基本はDebianをインストールしたくて、たまにCentOSも選びたいという程度なので、ここまでで止めておきます。</div>
</div>
<div class="line-block">
<div class="line">機会があれば、preseedやkickstartでホスト依存な部分(例えば固定IPとか)を都度生成してインストールする方法も考えたいですね。</div>
</div>
</div>
<div class="section" id="id11">
<h3>さらに読もうと思ってるサイト</h3>
<ul class="simple">
<li><dl class="first docutils">
<dt><a class="reference external" href="http://d.hatena.ne.jp/fujisan3776/20100630/1277861431">http://d.hatena.ne.jp/fujisan3776/20100630/1277861431</a></dt>
<dd>インストール中は別の作業をしているので、インストールが終わったことも知らせて欲しい</dd>
</dl>
</li>
</ul>
</div>
</div>

    </div>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://www.hitsumabushi.org/tag/pxe.html">pxe</a>
      <a href="https://www.hitsumabushi.org/tag/preseed.html">preseed</a>
      <a href="https://www.hitsumabushi.org/tag/kickstart.html">kickstart</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="https://www.hitsumabushi.org/blog/2014/01/01/0243.html" title="実UID, 実行UID">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="https://www.hitsumabushi.org/blog/2014/01/02/0240.html" title="便利なツール">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>



</article>

    <footer>
<p>
  &copy; 2021 hitsumabushi - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/deed.ja" target="_blank">Creative Commons Attribution-ShareAlike</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-nc/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-nc/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " ひつまぶし食べたい ",
  "url" : "https://www.hitsumabushi.org",
  "image": "/static/profile.jpg",
  "description": ""
}
</script>

</body>
</html>