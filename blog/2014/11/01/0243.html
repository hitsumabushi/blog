
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://www.hitsumabushi.org/theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="https://www.hitsumabushi.org/theme/pygments/monokai.min.css">

    <link rel="stylesheet" href="https://www.hitsumabushi.org/theme/tipuesearch/tipuesearch.min.css" />

  <link rel="stylesheet" type="text/css" href="https://www.hitsumabushi.org/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://www.hitsumabushi.org/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://www.hitsumabushi.org/theme/font-awesome/css/solid.css">

    <link rel="stylesheet" type="text/css" href="https://www.hitsumabushi.org/static/custom.css">

    <link href="https://www.hitsumabushi.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="ひつまぶし食べたい Atom">


    <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">

  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JPYFS3RY30"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JPYFS3RY30');
</script>
<!-- End of Global site tag (gtag.js) - Google Analytics -->

 

<meta name="author" content="hitsumabushi" />
<meta name="description" content="Consul とは 特徴 Service Discovery Consulのクライアントは、&#34;api&#34;や&#34;mysql&#34;といった与えられた名前を持つサービスを提供 他のクライアントは、Consulを使ってサービスを検出 アプリケーションはConsulが検出したサービスを、DNSやHTTP経由で検出 Health Check 多くのヘルスチェックの提供 実行されているサービスやノード上の情報などと連携 この情報を元に、クラスターの状態を監視 サービス …" />
<meta name="keywords" content="consul, provisioning, cluster">


  <meta property="og:site_name" content="ひつまぶし食べたい"/>
  <meta property="og:title" content="Consul 使ってみる"/>
  <meta property="og:description" content="Consul とは 特徴 Service Discovery Consulのクライアントは、&#34;api&#34;や&#34;mysql&#34;といった与えられた名前を持つサービスを提供 他のクライアントは、Consulを使ってサービスを検出 アプリケーションはConsulが検出したサービスを、DNSやHTTP経由で検出 Health Check 多くのヘルスチェックの提供 実行されているサービスやノード上の情報などと連携 この情報を元に、クラスターの状態を監視 サービス …"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://www.hitsumabushi.org/blog/2014/11/01/0243.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2014-11-01 02:43:20+09:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="https://www.hitsumabushi.org/author/hitsumabushi.html">
  <meta property="article:section" content="blog"/>
  <meta property="article:tag" content="consul"/>
  <meta property="article:tag" content="provisioning"/>
  <meta property="article:tag" content="cluster"/>
  <meta property="og:image" content="/static/profile.jpg">

  <title>ひつまぶし食べたい &ndash; Consul 使ってみる</title>

</head>
<body class="light-theme">
  <aside>
    <div>
      <a href="https://www.hitsumabushi.org/">
        <img src="/static/profile.jpg" alt="" title="">
      </a>

      <h1>
        <a href="https://www.hitsumabushi.org/"></a>
      </h1>

<p>メモ代わりのブログ</p>
        <form class="navbar-search" action="https://www.hitsumabushi.org/search.html" role="search">
          <input type="text" name="q" id="tipue_search_input" placeholder="Search...">
        </form>


      <ul class="social">
          <li>
            <a  class="sc-twitter" href="https://twitter.com/_hitsumabushi_" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-github" href="https://github.com/hitsumabushi" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="https://www.hitsumabushi.org/">Home</a>

      <a href="/archives.html">Archives</a>

      <a href="https://www.hitsumabushi.org/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="consul-shi-tsutemiru">Consul 使ってみる</h1>
    <p>
      Posted on Sat 01 November 2014 in <a href="https://www.hitsumabushi.org/category/blog.html">blog</a>

    </p>
  </header>


  <div>

    <div class="content">
      <div class="section" id="id1">
<h2>Consul とは</h2>
<div class="section" id="id2">
<h3>特徴</h3>
<ul>
<li><p class="first">Service Discovery</p>
<blockquote>
<ul class="simple">
<li>Consulのクライアントは、&quot;api&quot;や&quot;mysql&quot;といった与えられた名前を持つサービスを提供</li>
<li>他のクライアントは、Consulを使ってサービスを検出</li>
<li>アプリケーションはConsulが検出したサービスを、DNSやHTTP経由で検出</li>
</ul>
</blockquote>
</li>
<li><p class="first">Health Check</p>
<blockquote>
<ul class="simple">
<li>多くのヘルスチェックの提供</li>
<li>実行されているサービスやノード上の情報などと連携</li>
<li>この情報を元に、クラスターの状態を監視</li>
<li>サービス検出コンポーネントを使って、良くない状態のホストを迂回できる</li>
</ul>
</blockquote>
</li>
<li><p class="first">Key/Value Store</p>
<blockquote>
<ul class="simple">
<li>アプリケーションはConsulの階層的なKey/Valueストアを利用できる</li>
<li>動的な設定変更や、フラグを立てたり、色々使える</li>
<li>HTTP APIで簡単に使える</li>
</ul>
</blockquote>
</li>
<li><p class="first">Multi Datacenter</p>
<blockquote>
<ul class="simple">
<li>リージョンのことは気にしなくても、Consulが上手いことやる</li>
<li>(複数のgpssipプールを持っている云々書いているので、LANとWANで変えているのだと思う)</li>
</ul>
</blockquote>
</li>
</ul>
<p>ステータスの確認のためには、謎のキレイなWebUIもある。</p>
</div>
<div class="section" id="id3">
<h3>個人的に良いと思っているところ</h3>
<ul class="simple">
<li>DNSインターフェースでホストのIPを取得できるので、クラスター用のDNSサーバーのメンテナンスがいらないのが嬉しい</li>
<li>ホストの情報が散らばらずに、各サーバーで書かれている。それでいて、問い合わせは分散させられるのが嬉しい。</li>
<li>一貫性は正義</li>
</ul>
</div>
<div class="section" id="id4">
<h3>登場するサーバー</h3>
<ul>
<li><p class="first">Agent</p>
<blockquote>
<ul class="simple">
<li>Server or Client</li>
<li>HTTP, DNS, RPCのインターフェースを持ちうるやつ。
(実際に、持つかどうかは、起動時のclientオプションで決まる)</li>
</ul>
</blockquote>
</li>
<li><p class="first">Server</p>
<blockquote>
<ul class="simple">
<li>クラスタ状況の管理</li>
<li>クライアントからのRPCへの応答</li>
<li>WAN側gossip, リモートデータセンターのリーダーへクエリ</li>
<li>クラスタ内ではそれほど多くなくて良いはず</li>
</ul>
</blockquote>
</li>
<li><p class="first">Client</p>
<blockquote>
<ul class="simple">
<li>サーバーにRPCを送ってアピール</li>
<li>(gossipプールへの参加に関することを除いて、)割とステートレス</li>
<li>通信料もそんなに多くない</li>
<li>いくらでもいて良い</li>
</ul>
</blockquote>
</li>
</ul>
</div>
</div>
<div class="section" id="id5">
<h2>インストール</h2>
<p>バイナリを持ってきて、パス通ってるとこに置く。</p>
<p><a class="reference external" href="http://www.consul.io/downloads.html">http://www.consul.io/downloads.html</a></p>
</div>
<div class="section" id="id6">
<h2>起動方法</h2>
<ul class="simple">
<li>Agentの起動</li>
</ul>
<div class="highlight"><pre><span></span><span class="c1"># server : serverオプションを指定</span>
<span class="c1"># - clientオプションは、RPC, DNS, HTTPのためのもの</span>
<span class="c1"># - bindオプションは、cluster情報のやりとりに使うっぽい</span>
<span class="c1"># - dcはデータセンター名らしい</span>
<span class="c1"># - nodeはホスト名</span>
<span class="c1"># - bootstrapは最初の1つだけにつける。他は大体joinしとけば良い。</span>
consul<span class="w"> </span>agent<span class="w"> </span>-server<span class="w"> </span>-bootstrap<span class="w"> </span>-client<span class="o">=</span><span class="m">192</span>.168.2.5<span class="w"> </span>-dc<span class="o">=</span><span class="nb">local</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-node<span class="o">=</span>con<span class="w"> </span>-data-dir<span class="o">=</span>/tmp/consul<span class="w"> </span>-bind<span class="o">=</span><span class="m">192</span>.168.2.5

<span class="c1"># client</span>
<span class="c1"># - joinオプションで、agentのアドレスを指定。何個か書けるらしい</span>
consul<span class="w"> </span>agent<span class="w"> </span>-dc<span class="o">=</span><span class="nb">local</span><span class="w"> </span>-node<span class="o">=</span>consul2<span class="w"> </span>-data-dir<span class="o">=</span>/tmp/consul2<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-bind<span class="o">=</span><span class="m">192</span>.168.39.6<span class="w"> </span>-join<span class="o">=</span><span class="m">192</span>.168.39.5
</pre></div>
<ul class="simple">
<li>Agentの再起動</li>
</ul>
<p>Agentの再起動時には、 <em>SIGHUP</em> を送れば良い。</p>
</div>
<div class="section" id="id7">
<h2>使い方</h2>
<div class="section" id="cluster">
<h3>clusterからの情報を取得</h3>
<ul class="simple">
<li>Consulメンバー</li>
</ul>
<div class="highlight"><pre><span></span><span class="c1"># 自分の胸に聞くときは、&quot;-rpc-addr&quot;は不要</span>
consul<span class="w"> </span>members
<span class="c1"># クラスタの外にいたりして、誰かに教えてもらうとき</span>
consul<span class="w"> </span>members<span class="w"> </span>-rpc-addr<span class="o">=</span><span class="m">192</span>.168.2.5:8400
</pre></div>
<ul class="simple">
<li>HTTPインターフェース</li>
</ul>
<div class="highlight"><pre><span></span><span class="c1"># JSON形式で情報が返る</span>
curl<span class="w"> </span><span class="m">192</span>.168.2.5:8500/v1/catalog/nodes
</pre></div>
<ul class="simple">
<li>DNS</li>
</ul>
<div class="highlight"><pre><span></span><span class="c1"># 聞く先は適当に。 anyリクエスト投げとけば良いと思う</span>
<span class="c1"># &lt;hostname&gt;.node.consul (データセンターはlocalになる)という形式か、</span>
<span class="c1"># &lt;hostname&gt;.node.&lt;datacenter&gt;.consul という形式で問い合わせ。</span>
dig<span class="w"> </span>@192.168.2.5<span class="w"> </span>-p<span class="w"> </span><span class="m">8600</span><span class="w"> </span>con.node.local.consul
</pre></div>
</div>
<div class="section" id="key-value">
<h3>Key/Valueストア</h3>
<ul class="simple">
<li>put</li>
</ul>
<div class="highlight"><pre><span></span>curl<span class="w"> </span>-X<span class="w"> </span>PUT<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;first object&#39;</span><span class="w"> </span><span class="m">192</span>.168.2.5:8500/v1/kv/namespaces/keyname

<span class="c1"># Check-And-Set : atomicなkey変更をするときに使うパラメータ</span>
<span class="c1"># ModifyIndex の値を指定して更新できる。</span>
<span class="c1"># まず、GETしてModifyIndexを見てPUTする、という操作をatomicにできる</span>
curl<span class="w"> </span>-X<span class="w"> </span>PUT<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;first object&#39;</span><span class="w"> </span><span class="m">192</span>.168.2.5:8500/v1/kv/namespaces/keyname?cas<span class="o">=</span><span class="m">97</span>
</pre></div>
<ul class="simple">
<li>get</li>
</ul>
<div class="highlight"><pre><span></span>curl<span class="w"> </span>-s<span class="w"> </span><span class="m">192</span>.168.2.5:8500/v1/kv/namespaces/keyname
<span class="c1"># =&gt; jsonが改行もされず表示されて辛い気持ちになる</span>
curl<span class="w"> </span>-s<span class="w"> </span><span class="m">192</span>.168.2.5:8500/v1/kv/namespaces/keyname<span class="w"> </span><span class="p">|</span><span class="w"> </span>python<span class="w"> </span>-mjson.tool
<span class="c1"># =&gt; 見やすくしてくれる</span>
curl<span class="w"> </span>-s<span class="w"> </span><span class="m">192</span>.168.2.5:8500/v1/kv/namespaces/?recurse
<span class="c1"># =&gt; 再帰的に見てくれる</span>

<span class="c1"># index=101 : ModifyIndexが101より大きいものが帰ってくるまで聞き続ける</span>
<span class="c1"># wait=5s などすれば、5秒までしか聞かない</span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h2>もっとConsul</h2>
<div class="section" id="service-health-check">
<h3>Service, Health Check を定義する</h3>
<div class="line-block">
<div class="line">定義はjson形式で書く。</div>
<div class="line">サービスを定義したいサーバーの例えば、/etc/consul.d/以下に</div>
</div>
<div class="highlight"><pre><span></span><span class="err">#</span><span class="w"> </span><span class="err">/e</span><span class="kc">t</span><span class="err">c/co</span><span class="kc">nsul</span><span class="err">.d/mysql.jso</span><span class="kc">n</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="err">サービスを定義</span>
<span class="p">{</span><span class="nt">&quot;service&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;mysql&quot;</span><span class="p">,</span><span class="w">  </span><span class="nt">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;mysql&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;db&quot;</span><span class="p">],</span><span class="w">  </span><span class="nt">&quot;port&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3306</span><span class="p">}}</span>

<span class="err">#</span><span class="w"> </span><span class="err">/e</span><span class="kc">t</span><span class="err">c/co</span><span class="kc">nsul</span><span class="err">.d/pi</span><span class="kc">n</span><span class="err">g.jso</span><span class="kc">n</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="err">pi</span><span class="kc">n</span><span class="err">gステータスをチェック</span>
<span class="p">{</span>
<span class="nt">&quot;check&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ping&quot;</span><span class="p">,</span><span class="w">  </span><span class="nt">&quot;script&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ping -c1 google.com &gt;/dev/null&quot;</span><span class="p">,</span><span class="w">  </span><span class="nt">&quot;interval&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;30s&quot;</span><span class="p">}</span>
<span class="p">}</span>

<span class="err">#</span><span class="w"> </span><span class="err">/e</span><span class="kc">t</span><span class="err">c/co</span><span class="kc">nsul</span><span class="err">.d/web.jso</span><span class="kc">n</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="err">サービスを定義しつつ、サービスレベルでヘルスチェック</span>
<span class="p">{</span><span class="nt">&quot;service&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;web&quot;</span><span class="p">,</span><span class="w">  </span><span class="nt">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;rails&quot;</span><span class="p">],</span><span class="w">  </span><span class="nt">&quot;port&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span>
<span class="nt">&quot;check&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;script&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;curl localhost:80 &gt;/dev/null 2&gt;&amp;1&quot;</span><span class="p">,</span><span class="w">  </span><span class="nt">&quot;interval&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;30s&quot;</span><span class="p">}}}</span>
</pre></div>
<p>とか書いて、起動オプションに、 -config-dir=/etc/consul.d を加える。</p>
</div>
<div class="section" id="service-halth">
<h3>Service, Halthの確認</h3>
<p>他のサーバーから定義されたサービスやステータスを知りたい。</p>
<ul class="simple">
<li>DNS</li>
</ul>
<div class="line-block">
<div class="line">NAME.service.consul or TAG.NAME.service.consul を使う。</div>
<div class="line">さらに、SRVレコードを見れば、ポートもわかる</div>
</div>
<div class="highlight"><pre><span></span><span class="c1"># Serviceを知る</span>
dig<span class="w"> </span>@127.0.0.1<span class="w"> </span>-p<span class="w"> </span><span class="m">8600</span><span class="w"> </span>mysql.service.consul<span class="w"> </span>SRV
dig<span class="w"> </span>@127.0.0.1<span class="w"> </span>-p<span class="w"> </span><span class="m">8600</span><span class="w"> </span>db.mysql.service.consul<span class="w"> </span>SRV

<span class="c1"># Health Checkに失敗してるやつ</span>
dig<span class="w"> </span>@127.0.0.1<span class="w"> </span>-p<span class="w"> </span><span class="m">8600</span><span class="w"> </span>web.service.consul
</pre></div>
<ul class="simple">
<li>HTTP</li>
</ul>
<div class="highlight"><pre><span></span><span class="c1"># Serviceを知る</span>
curl<span class="w"> </span>-s<span class="w"> </span>http://192.168.2.5:8500/v1/catalog/service/mysql

<span class="c1"># Halth Checkに失敗してるやつ</span>
curl<span class="w"> </span>http://localhost:8500/v1/health/state/critical
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h2>参考資料</h2>
<ul class="simple">
<li><a class="reference external" href="http://www.consul.io/intro/index.html">Introduction to Consul</a></li>
<li><a class="reference external" href="http://www.consul.io/intro/vs/serf.html">Consul vs. Serf</a> (<a class="reference external" href="http://pocketstudio.jp/log3/2014/04/19/translation_consul_related_documents/">Consul vs Serfの日本語訳</a>)</li>
<li><a class="reference external" href="http://www.slideshare.net/sonots/serf-iiconf-20140325">Serf という Orchestration ツール #immutableinfra</a></li>
</ul>
<div class="section" id="advanced">
<h3>Advanced</h3>
<ul class="simple">
<li><a class="reference external" href="http://www.consul.io/docs/internals/index.html">http://www.consul.io/docs/internals/index.html</a></li>
</ul>
</div>
</div>

    </div>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://www.hitsumabushi.org/tag/consul.html">consul</a>
      <a href="https://www.hitsumabushi.org/tag/provisioning.html">provisioning</a>
      <a href="https://www.hitsumabushi.org/tag/cluster.html">cluster</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="https://www.hitsumabushi.org/blog/2014/08/14/1639.html" title="vSphere API事始め">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="https://www.hitsumabushi.org/blog/2014/12/15/2300.html" title="drone.ioを使って、pelicanをビルドする">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>



</article>

    <footer>
<p>
  &copy; 2021 hitsumabushi - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/deed.ja" target="_blank">Creative Commons Attribution-ShareAlike</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-nc/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-nc/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " ひつまぶし食べたい ",
  "url" : "https://www.hitsumabushi.org",
  "image": "/static/profile.jpg",
  "description": ""
}
</script>

</body>
</html>