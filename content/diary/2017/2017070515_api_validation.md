Title: 手で書かれたswagger fileを元にAPIをテストする
Date: 2017-05-15 15:08
Category: blog
Tags: api, swagger
Status: draft

[TOC]

# 背景

テストされていないコードにテストを追加する活動をする。
* サービス開発に参加したのは、リリース2ヶ月前
* コードのメインは、API・バックエンドのコード
* コード自体は、Github Enterprise にホストされている
* リリースに向けて、不足している機能もあるため、開発しつつ改善活動をする
* 既存のコードもかなり大きいので、一から書き換えるのは時間的な制約から難しい

# 課題

機能追加されたり、UI側の要望などでAPIを変更した場合に、全体として追従できない。
ドキュメントが更新されなかったり、CLIが更新されなかったりしている。
何を更新しないといけないか把握できていて、アクションできている人がいない。

# 改善

1. 不整合が起きたことを **テスト** によって把握できるようにする
2. 不整合が起きない/起きにくいようにする

# 活動

0. [X] CI環境の整備
1. [X] 課金情報周りの Unitテストを書く活動
3. [ ] API周りのテスト活動 ← イマココ
4. [ ] APIドキュメント生成する活動

## 活動の詳細

### 0. CI環境の整備

CIするためのビルドサーバーがなかった。
何を始めるにも、自動でビルドできるサーバーが必要なので、
お手軽にJenkinsを立てた。

最近のJenkins は `.Jenkinsfile` ファイルを書くことで、ビルド内容を定義できるため、手で色々やる必要がない。
dockerコンテナを利用してビルドする、簡単な `.Jenkinsfile` の例を書いて、共有しておき、pushやPRのタイミングで自動ビルドできるようにした。

### 1. 課金情報周りの Unitテストを書く活動

リリースまで時間も限られているので、最も優先度の高い部分のテストを書くことにした。
そもそもテストしづらいタイプの大きなメソッドを分割することことから始めて、00% → 80%↑ 程度までテストを書いた。

