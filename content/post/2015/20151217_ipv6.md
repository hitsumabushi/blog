---
title: IPv6の基本についてまとめる
date: 2015-12-17T05:54:00+09:00
slug: 0554
categories:
  - blog
tags:
  - IPv6
  - network
draft: true
---


自宅環境をデュアルスタックにしたいので、ルーターのIPv6の設定を調べていた。
IPv6自体の理解が一部怪しいところもあったので、基本的なところから、まとめていく。

## アドレスの表現
### アドレス形式
128bitを使ったアドレス。

### 表示形式
`2001:0db8:0:0:1111:2222:3333:9abe` のような8つの16bitの16進数で表示される。
ただ、ipv6アドレスは長くなりがちであるので、書くのが大変だし読みづらい。
0が続くフィールドは省略できるように、ということで、[RFC5952](http://tools.ietf.org/html/rfc5952) がある。
ざっくり言うとルールとしては、以下の3つ。

1. 各フィールドの先頭に0がある場合には省略する
    - 例えば、 `...:00a2:...` というのは、 `...:a2:...` と書かれる
2. フィールドに0が続く場合、 `::` を使う
    - `...:a:0:0:0:b:...` というアドレスがあった時、0がたくさん続くと読みづらい。こういう場合に、`...:a::b:...` と書くことにする。`::`の部分は0が入る。
        - `1::2` とあったら、`1:0:0:0:0:0:0:2` というアドレスになるということ
    - `...:a:0:b:...` というような 0のフィールドが続かない場合には、 `...:a::b:...` と書くのはNG。
    - `::`は最も短い表現ができるようにする
        - `...a:0:0:0:0:b...` があった時、 `...a:0::b` などの中途半端に `::`で省略するのはNG。
        - 最も0のフィールドが連続している場所に `::` を利用する。例えば、`a:0:0:b:0:0:0:c` というアドレスがあった場合、 `a::b:0:0:0:c` と書くのは許されない。必ず、`a:0:0:b::c` である必要がある。
            + (補足) `a::b::c` と書くのはNG。 元のアドレスが復元できないので。 `a:0:0:0:b:0:0:c`でも同じになってしまう。そのため、 `::` は1度しか使えない。
        - `a:0:0:b:0:0:c:d` のように、省略可能なフィールドが複数あり、長さが同じ場合、先頭にある方を省略する。 つまり、 `a::b:0:0:c:d` と書く。
3. "A"~"F"の文字は小文字を使う
    - `...:123A:...` などは `...:123a:` と書かれる。
    - インターネット上の文書で、これに従っていないものが散見されるので、注意したほうが良い。

## アドレスの分類 : [RFC4291](https://tools.ietf.org/html/rfc4291)
### アドレスタイプの分類
1. ユニキャスト
    - インターフェースの識別子になる。
    - ユニキャストアドレスにパケットが送信された場合、対象のユニキャストアドレスを持つ単一のインターフェースにパケットが配送される。
2. エニーキャストアドレス
    - インターフェースの集合の識別子になる。
    - エニーキャストアドレスにパケットが送信された場合、対象のエニーキャストアドレスに所属するインターフェースのうち、1つのインターフェースにパケットが配送される。
        + ルーティングプロトコル上で決まる、**最も近い** インターフェースに配送される
3. マルチキャスト
    - インターフェースの集合の識別子になる。
    - マルチキャストアドレスにパケットが送信された場合、対象のマルチキャストアドレスに所属する、すべてのインターフェースにパケットが配送される。

IPv4との違いとしては、
- エニーキャストアドレスという概念ができた
- ブロードキャストアドレスがなく、代わりにマルチキャストアドレスを使う

### ユニキャスト
#### アドレス形式
`{n bit: subnet prefix}:{128-n bit: Interface ID}` という形式になっている。
Interface IDについては、生成方法がいくつかあるけど、ここでは書かない。

#### 例
1. 未指定アドレス
    - 0:0:0:0:0:0:0:0
    - インターフェースにアサインされることはない
2. loopback アドレス
    - 0:0:0:0:0:0:0:1
    - Link-Local アドレスの1つとして扱われる
3. Link-Local ユニキャストアドレス
    - fe80::/10
    - インターフェースは必ず、1つはLink-Localユニキャストアドレスを持つ
    - ルーターによって転送されないので、同じL2ドメインにあるノードでしか通信できない
4. ユニークローカル ユニキャストアドレス : [RFC4193](https://tools.ietf.org/html/rfc4193)
    - fc00::/7
    - IPv4でいうところのプライベートアドレスとして使う想定で運用される(グローバルで疎通できないようになっているはず)
    - アドレス範囲は以下のような分類がある
        + fc00::/8 : IANAで管理されるようなので、申請したら取れるようになると思うけど、まだアサインされる方法がないので、使う方法がない。
        + fd00::/8 : 勝手に使って良い。ただ、擬似乱数でsubnet prefixを生成しなければならない。
            - 生成するツールを公開している人もいる
4. Global ユニキャストアドレス
    - ルーターによって転送されるなど、ルーティングされる範囲で通信が可能なアドレス
    - グローバルに通信ができるかどうかは、上位ルーターの設定次第なので、特に区別はない
### エニーキャスト
ユニキャストのアドレス空間から割り当てられるため、アドレスをみただけでは、エニーキャストかどうか判別できない。
複数のインターフェースに割り当てられた時点で、エニーキャストアドレスになる。
割り当てられたインターフェース側では、それがエニーキャストアドレスであることがわかるように構成されなければならない。

割り当てられたエニキャストアドレスに足しいて、すべてのインターフェースが属する、トポロジカルな範囲を識別するための、最小のプレフィックスPがある。
このPの範囲の中では、エニキャストアドレスは、ルーティングシステムとは別のシステムとして(ホストルートと呼ばれる)保守されなければならない。
Pの範囲の外では、エニキャストアドレスをPのためのルーティングエントリに集約しても良い。

#### 例
サブネットルータ エニキャストアドレスは事前に定義されている。
`{n bit: subnet prefix}::` というアドレスは、サブネット上のどれか1つのルーターに配送されることになる。

### マルチキャスト
`FF00::/8` が利用される。

```
| 8bit   | 4bit |  4bit |                 112bit                  |
+--------+------+-------+-----------------------------------------+
|11111111| flag | scope |                 group ID                |
+--------+------+-------+-----------------------------------------+
```

- flag = 0RPT というビット列
    + R
        + 0 : `multicast address that does not embed the address of the RP` (RPはRendezvous Point のこと)
        + 1 : `multicast address that embeds the address on the RP.`
    + P
        + 0 : network prefix ベースでない場合。(network prefix ベースであるときは、group IDの中に、network prefixの情報が埋め込まれている)
        + 1 : network prefix ベースの割当。この場合、Tは必ず1になる。
    + T
        + 0 : permanent
            - "well-known"なものに使う。つまりIANAで管理されている。
        + 1 : non-permanently-assigned
- scope
    + 0: reserved
    + 1: Interface-Local scope
    + 2: Link-Local scope
    + 3: reserved
    + 4: Admin-Local scope
    + 5: Site-Local scope
    + 6: (unassigned)
    + 7: (unassigned)
    + 8: Organization-Local scope
    + 9: (unassigned)
    + A: (unassigned)
    + B: (unassigned)
    + C: (unassigned)
    + D: (unassigned)
    + E: Global scope
    + F: reserved

- group ID
    + マルチキャストグループの識別子

#### 例
`FF01::1`, `FF02::1` はそれぞれ、インターフェースローカルか、リンクローカルのすべてのIPv6ノードのグループ。

