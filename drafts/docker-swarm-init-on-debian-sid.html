
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://www.hitsumabushi.org/theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="https://www.hitsumabushi.org/theme/pygments/monokai.min.css">

    <link rel="stylesheet" href="https://www.hitsumabushi.org/theme/tipuesearch/tipuesearch.min.css" />

  <link rel="stylesheet" type="text/css" href="https://www.hitsumabushi.org/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://www.hitsumabushi.org/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://www.hitsumabushi.org/theme/font-awesome/css/solid.css">

    <link rel="stylesheet" type="text/css" href="https://www.hitsumabushi.org/static/custom.css">

    <link href="https://www.hitsumabushi.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="ひつまぶし食べたい Atom">


    <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">

  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JPYFS3RY30"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JPYFS3RY30');
</script>
<!-- End of Global site tag (gtag.js) - Google Analytics -->

 

<meta name="author" content="hitsumabushi" />
<meta name="description" content="内容 Debian Sid (2016/09/20 時点)で、 Docker Engine の swarm mode を初期設定したメモ。 手順 docker engine の設定 Installation on Debian sudo apt-get purge -y &#34;lxc-docker*&#34; sudo apt-get purge -y &#34;docker.io*&#34; sudo apt-get update -y sudo apt-get install -y apt-transport-https ca-certificates sudo apt-key adv --keyserver p80.pool.sks-keyservers.net --recv-keys 58118E89F3A912897C070ADBF76221572C52609D echo &#34;deb https://apt.dockerproject.org/repo debian-stretch main&#34; | sudo tee /etc/apt/sources.list.d/docker.list sudo apt-get update -y sudo apt-get install -y docker-engine swarm 初期化 # Manager $ sudo docker swarm init --advertise-addr 192.168.253.158 Swarm initialized: current node (92c34zr76hdav65q97pybnii6) is now a manager. To add a worker to this swarm, run the following command: docker swarm join \ --token SWMTKN-1-305k6qcpoghq89avwv0pu6dxj2e00utvno7hx7ctdp5no7meuu-737dwq5cmuab1p30hyx5rpd6t \ 192.168.253.158:2377 To add a manager to …" />
<meta name="keywords" content="docker, debian">


  <meta property="og:site_name" content="ひつまぶし食べたい"/>
  <meta property="og:title" content="docker swarm init on Debian Sid"/>
  <meta property="og:description" content="内容 Debian Sid (2016/09/20 時点)で、 Docker Engine の swarm mode を初期設定したメモ。 手順 docker engine の設定 Installation on Debian sudo apt-get purge -y &#34;lxc-docker*&#34; sudo apt-get purge -y &#34;docker.io*&#34; sudo apt-get update -y sudo apt-get install -y apt-transport-https ca-certificates sudo apt-key adv --keyserver p80.pool.sks-keyservers.net --recv-keys 58118E89F3A912897C070ADBF76221572C52609D echo &#34;deb https://apt.dockerproject.org/repo debian-stretch main&#34; | sudo tee /etc/apt/sources.list.d/docker.list sudo apt-get update -y sudo apt-get install -y docker-engine swarm 初期化 # Manager $ sudo docker swarm init --advertise-addr 192.168.253.158 Swarm initialized: current node (92c34zr76hdav65q97pybnii6) is now a manager. To add a worker to this swarm, run the following command: docker swarm join \ --token SWMTKN-1-305k6qcpoghq89avwv0pu6dxj2e00utvno7hx7ctdp5no7meuu-737dwq5cmuab1p30hyx5rpd6t \ 192.168.253.158:2377 To add a manager to …"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://www.hitsumabushi.org/drafts/docker-swarm-init-on-debian-sid.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2016-09-20 15:07:00+09:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="https://www.hitsumabushi.org/author/hitsumabushi.html">
  <meta property="article:section" content="blog"/>
  <meta property="article:tag" content="docker"/>
  <meta property="article:tag" content="debian"/>
  <meta property="og:image" content="/static/profile.jpg">

  <title>ひつまぶし食べたい &ndash; docker swarm init on Debian Sid</title>

</head>
<body class="light-theme">
  <aside>
    <div>
      <a href="https://www.hitsumabushi.org/">
        <img src="/static/profile.jpg" alt="" title="">
      </a>

      <h1>
        <a href="https://www.hitsumabushi.org/"></a>
      </h1>

<p>メモ代わりのブログ</p>
        <form class="navbar-search" action="https://www.hitsumabushi.org/search.html" role="search">
          <input type="text" name="q" id="tipue_search_input" placeholder="Search...">
        </form>


      <ul class="social">
          <li>
            <a  class="sc-twitter" href="https://twitter.com/_hitsumabushi_" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-github" href="https://github.com/hitsumabushi" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="https://www.hitsumabushi.org/">Home</a>

      <a href="/archives.html">Archives</a>

      <a href="https://www.hitsumabushi.org/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="docker-swarm-init-on-debian-sid">docker swarm init on Debian Sid</h1>
    <p>
      Posted on Tue 20 September 2016 in <a href="https://www.hitsumabushi.org/category/blog.html">blog</a>

    </p>
  </header>


  <div>
    <div class="toc">
<ul>
<li><a href="#_1">内容</a></li>
<li><a href="#_2">手順</a><ul>
<li><a href="#docker-engine">docker engine の設定</a></li>
<li><a href="#swarm">swarm 初期化</a></li>
<li><a href="#swarm_1">swarm での動作</a></li>
</ul>
</li>
<li><a href="#tips">TIPS</a><ul>
<li><a href="#systemd-unit-file-environmetfile-">systemd unit file の中で、 EnvironmetFile=- というのは一体なに?</a></li>
<li><a href="#execstart-2">どうして、ExecStart が2行書かれているの?</a></li>
<li><a href="#targz">tar.gz をダウンロードして、どこかのディレクトリに展開する</a></li>
</ul>
</li>
</ul>
</div>

    <div class="content">
      
<h2 id="_1">内容</h2>
<p>Debian Sid (2016/09/20 時点)で、 Docker Engine の swarm mode を初期設定したメモ。</p>
<h2 id="_2">手順</h2>
<h3 id="docker-engine">docker engine の設定</h3>
<p><a href="https://docs.docker.com/engine/installation/linux/debian/#/debian-wheezy-stable-7-x-64-bit">Installation on Debian</a></p>
<div class="highlight"><pre><span></span><code>sudo apt-get purge -y "lxc-docker*"
sudo apt-get purge -y "docker.io*"
sudo apt-get update -y
sudo apt-get install -y apt-transport-https ca-certificates
sudo apt-key adv --keyserver p80.pool.sks-keyservers.net --recv-keys 58118E89F3A912897C070ADBF76221572C52609D
echo "deb https://apt.dockerproject.org/repo debian-stretch main" | sudo tee /etc/apt/sources.list.d/docker.list
sudo apt-get update -y
sudo apt-get install -y docker-engine
</code></pre></div>
<h3 id="swarm">swarm 初期化</h3>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">Manager</span>
<span class="err">$</span><span class="w"> </span><span class="nx">sudo</span><span class="w"> </span><span class="nx">docker</span><span class="w"> </span><span class="nx">swarm</span><span class="w"> </span><span class="nx">init</span><span class="w"> </span><span class="o">--</span><span class="nx">advertise</span><span class="o">-</span><span class="kd">addr</span><span class="w"> </span><span class="m m-Double">192.168.253.1</span><span class="mi">58</span>
<span class="nx">Swarm</span><span class="w"> </span><span class="nx">initialized</span><span class="p">:</span><span class="w"> </span><span class="nx">current</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="p">(</span><span class="mi">92</span><span class="nx">c34zr76hdav65q97pybnii6</span><span class="p">)</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">manager</span><span class="p">.</span>

<span class="nx">To</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">worker</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">swarm</span><span class="p">,</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">following</span><span class="w"> </span><span class="nx">command</span><span class="p">:</span>

<span class="w">    </span><span class="nx">docker</span><span class="w"> </span><span class="nx">swarm</span><span class="w"> </span><span class="nx">join</span><span class="w"> </span>\
<span class="w">    </span><span class="o">--</span><span class="nx">token</span><span class="w"> </span><span class="nx">SWMTKN</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">305</span><span class="nx">k6qcpoghq89avwv0pu6dxj2e00utvno7hx7ctdp5no7meuu</span><span class="o">-</span><span class="mi">737</span><span class="nx">dwq5cmuab1p30hyx5rpd6t</span><span class="w"> </span>\
<span class="w">    </span><span class="m m-Double">192.168.253.1</span><span class="mi">58</span><span class="p">:</span><span class="mi">2377</span>

<span class="nx">To</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">manager</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">swarm</span><span class="p">,</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="err">'</span><span class="nx">docker</span><span class="w"> </span><span class="nx">swarm</span><span class="w"> </span><span class="nx">join</span><span class="o">-</span><span class="nx">token</span><span class="w"> </span><span class="nx">manager</span><span class="err">'</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">follow</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">instructions</span><span class="p">.</span>
<span class="err">$</span><span class="w"> </span><span class="nx">sudo</span><span class="w"> </span><span class="nx">docker</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="nx">ls</span>
<span class="nx">ID</span><span class="w">                           </span><span class="nx">HOSTNAME</span><span class="w">    </span><span class="nx">STATUS</span><span class="w">  </span><span class="nx">AVAILABILITY</span><span class="w">  </span><span class="nx">MANAGER</span><span class="w"> </span><span class="nx">STATUS</span>
<span class="mi">92</span><span class="nx">c34zr76hdav65q97pybnii6</span><span class="w"> </span><span class="o">*</span><span class="w">  </span><span class="nx">workdebian</span><span class="w">  </span><span class="nx">Ready</span><span class="w">   </span><span class="nx">Active</span><span class="w">        </span><span class="nx">Leader</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code># Add worker nodes to manager
$ sudo docker swarm join --token SWMTKN-1-305k6qcpoghq89avwv0pu6dxj2e00utvno7hx7ctdp5no7meuu-737dwq5cmuab1p30hyx5rpd6t 192.168.253.158:2377
</code></pre></div>
<h3 id="swarm_1">swarm での動作</h3>
<p>...</p>
<h2 id="tips">TIPS</h2>
<h3 id="systemd-unit-file-environmetfile-">systemd unit file の中で、 EnvironmetFile=- というのは一体なに?</h3>
<p><a href="https://docs.docker.com/engine/admin/systemd/">Custom Docker daemon options</a> の例で、 <code>EnvironmetFile=-...</code> という形式の設定があった。これは一体なにか。</p>
<div class="highlight"><pre><span></span><code>EnvironmentFile=-/etc/sysconfig/docker
EnvironmentFile=-/etc/sysconfig/docker-storage
EnvironmentFile=-/etc/sysconfig/docker-network
</code></pre></div>
<p><a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html">systemd.unit(5)</a>には書かれていない。<br/>
<code>EnvironmetFile</code> を含むいくつかの設定は、 <a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html">systemd.exec(5)</a> というのに書かれている。(exec となっているが、 configurationについてのもの)</p>
<p><a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#EnvironmentFile=">EnvironmentFile=</a> によると、</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="n">The</span><span class="w"> </span><span class="n">argument</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">absolute</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">wildcard</span><span class="w"> </span><span class="n">expression</span><span class="p">,</span><span class="w"> </span><span class="n">optionally</span><span class="w"> </span><span class="n">prefixed</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="s">"-"</span><span class="p">,</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">indicates</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">exist</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">logged</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">specified</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">once</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">specified</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">read</span><span class="p">.</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">empty</span><span class="w"> </span><span class="k">string</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">assigned</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">option</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">reset</span><span class="p">,</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">prior</span><span class="w"> </span><span class="n">assignments</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">effect</span><span class="p">.</span>
</code></pre></div>
<p>と書かれている。</p>
<h3 id="execstart-2">どうして、ExecStart が2行書かれているの?</h3>
<p>Dockerの unti fileを見ると、以下のように、<code>ExecStart=</code>が2つあり、1つは空、もう1つが実際に実行したいものを書いている、という設定を見ることになる。</p>
<div class="highlight"><pre><span></span><code>ExecStart=
ExecStart=/usr/bin/dockerd ...
</code></pre></div>
<p>これは、こう書かないといけない、という類のものらしい。<br/>
1つ目は設定を消すためのもので消していないと、複数回ExecStartが書かれているという内容のエラーが出る。</p>
<ul>
<li><a href="https://github.com/docker/docker/issues/14491">参考情報</a></li>
</ul>
<h3 id="targz">tar.gz をダウンロードして、どこかのディレクトリに展開する</h3>
<p>下記のように、curl でダウンロードしたものを標準出力に出して、それを tar で受けるのが、docker iamgeを小さく保つのには良さそう</p>
<div class="highlight"><pre><span></span><code>RUN<span class="w"> </span>curl<span class="w"> </span>-sL<span class="w"> </span>"https://github.com/.../archive/<span class="cp">${</span><span class="n">VERSION</span><span class="cp">}</span>.tar.gz"<span class="w"> </span>|<span class="w"> </span>tar<span class="w"> </span>-xzC<span class="w"> </span>"<span class="cp">${</span><span class="n">APACHE_WEBROOT_DIR</span><span class="cp">}</span>"<span class="w"> </span>--strip-components=1
</code></pre></div>
<p>tar のオプションとして、 <code>-C</code> でディレクトリを指定していて、 これだけだと、ディレクトリの下に、解凍時に(割と一般的に)作成されるトップのフォルダができてしまうので、<br/>
<code>--strip-components=1</code> にして、トップのフォルダを無視する。</p>
<p>ちなみに、デバッグしたくなったら、以下のように <code>od</code> をすると便利そう。</p>
<div class="highlight"><pre><span></span><code>RUN<span class="w"> </span>curl<span class="w"> </span>-sL<span class="w"> </span>"https://github.com/.../archive/<span class="cp">${</span><span class="n">VERSION</span><span class="cp">}</span>.tar.gz"<span class="w"> </span>&gt;<span class="w"> </span>/tmp/x<span class="w"> </span><span class="err">&amp;&amp;</span><span class="w"> </span>od<span class="w"> </span>-c<span class="w"> </span>/tmp/x<span class="w"> </span>|<span class="w"> </span>head
</code></pre></div>
    </div>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://www.hitsumabushi.org/tag/docker.html">docker</a>
      <a href="https://www.hitsumabushi.org/tag/debian.html">debian</a>
    </p>
  </div>


  <div class="neighbors">
  </div>

  <div class="related-posts">
    <h4>You might enjoy</h4>
    <ul class="related-posts">
      <li><a href="https://www.hitsumabushi.org/blog/2015/09/15/0421.html">Dockerの細々としたメモ</a></li>
      <li><a href="https://www.hitsumabushi.org/blog/2015/01/29/0754.html">Dockerのプロキシ設定</a></li>
      <li><a href="https://www.hitsumabushi.org/blog/2017/12/01/2001.html">Mesos の sandbox のログローテーションをする</a></li>
      <li><a href="https://www.hitsumabushi.org/blog/2016/09/27/1445.html">DockerHub で docker build のオプションを設定したい</a></li>
      <li><a href="https://www.hitsumabushi.org/blog/2018/10/31/1901.html">DebianでLuaJITTeXを使いたい</a></li>
    </ul>
  </div>


</article>

    <footer>
<p>
  &copy; 2021 hitsumabushi - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/deed.ja" target="_blank">Creative Commons Attribution-ShareAlike</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-nc/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-nc/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " ひつまぶし食べたい ",
  "url" : "https://www.hitsumabushi.org",
  "image": "/static/profile.jpg",
  "description": ""
}
</script>

</body>
</html>