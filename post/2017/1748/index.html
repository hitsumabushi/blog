<!doctype html><html lang=ja><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="ひつまぶし食べたい"><meta property="og:type" content="article"><meta property="og:image" content="https://www.hitsumabushi.org//img/home-bg-jeep.jpg"><meta property="twitter:image" content="https://www.hitsumabushi.org//img/home-bg-jeep.jpg"><meta name=title content="さくらのクラウドでN百台を管理するためにterraformとansibleを使っている話"><meta property="og:title" content="さくらのクラウドでN百台を管理するためにterraformとansibleを使っている話"><meta property="twitter:title" content="さくらのクラウドでN百台を管理するためにterraformとansibleを使っている話"><meta name=description content="Topic around SRE, Management, Cloud, Infrastructure Engineering, Software Engineering, Programming"><meta property="og:description" content="Topic around SRE, Management, Cloud, Infrastructure Engineering, Software Engineering, Programming"><meta property="twitter:description" content="Topic around SRE, Management, Cloud, Infrastructure Engineering, Software Engineering, Programming"><meta property="twitter:card" content="summary"><meta name=keyword content="hitsumabushi,SRE,Management,Cloud,Infrastructure,Software,Programming,Engineering"><link rel="shortcut icon" href=/img/favicon.ico><title>さくらのクラウドでN百台を管理するためにterraformとansibleを使っている話 | ひつまぶし食べたい</title>
<link rel=canonical href=/post/2017/1748/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><link rel=stylesheet href=https://www.hitsumabushi.org/css/hugo-theme-clearnwhite/custom-font.css><link rel=stylesheet href=https://www.hitsumabushi.org/css/hugo-theme-clearnwhite/main.css><script src=/js/jquery.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/hux-blog.min.js></script><script src=/js/lazysizes.min.js></script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-JPYFS3RY30"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JPYFS3RY30")}</script><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=/>ひつまぶし食べたい</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/home-bg-jeep.jpg)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/sakrua title=sakrua>sakrua
</a><a class=tag href=/tags/ansible title=ansible>ansible
</a><a class=tag href=/tags/terraform title=terraform>terraform</a></div><h1>さくらのクラウドでN百台を管理するためにterraformとansibleを使っている話</h1><h2 class=subheading></h2><span class=meta>Posted by
ひつまぶし食べたい
on
Tuesday, December 5, 2017</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><hr><p>これは、<a href=https://qiita.com/advent-calendar/2017/sakura>さくらインターネット Advent Calendar 2017</a> として書いた<a href=https://qiita.com/hitsumabushi/items/e89b763dd4fc41e15136>記事</a> です。</p><hr><p>さくらインターネットでは、今年4月からIoTプラットフォームの sakura.io をサービス提供しています。
sakura.io は、さくらのクラウド上で本番・検証環境を構築しており、数百台のサーバーを利用しています。</p><p>私はリリース直前にチームに参加し、開発の傍ら運用改善活動をしていました。
その結果としてTerraform を導入し、Terraform (+ Terraform for さくらのクラウド) + Ansible で運用することになりました。
導入までの課題と、どのように導入・利用しているのか、について書きたいと思います。</p><h2 id=運用の課題>運用の課題</h2><h3 id=検証環境と本番環境で構成に差分がありそれに気づきづらい>検証環境と本番環境で構成に差分があり、それに気づきづらい</h3><p>mesos+marathon を利用したコンテナ実行環境を使ったマイクロサービスアーキテクチャになっていて、それ以外にも、redis, memcached, メッセージキューなどいろいろなコンポーネントがあります。
そのため、個別の開発者がクリーンな環境を気軽に用意しづらいです。</p><p>インフラの構成を変更したいと思ったとき、個別の開発者がクリーンな環境を個別に作るのは手間がかかってしまうため、直接検証環境でテストしがちです。その際に、行われた変更がそのまま残ってしまい、本番環境との差が残ってしまっているケースがありました。</p><h3 id=ansible-playbook-の内容と現実に差分がある>Ansible Playbook の内容と現実に差分がある</h3><p>もともとOS内の設定はansibleで管理していたのですが、対象ホストの増加、ansible playbookの肥大化に伴い、実行時間が増えてしまいました。
それに伴い、<code>--limit</code>, <code>--tags</code> をつけて部分的に実行するようになり、playbook と差分が散見されるようになりました。</p><h2 id=方針>方針</h2><p>ansible は全部実行しろ、などとルールを作ることは簡単なのですが、上記に書いたとおり、心理的なハードルによって発生している問題だと思いました。そこでルール化することはエンジニアリングの敗北という感じがしたので、差分がわかるように構成管理することと、差分を定期的にチェックして通知することに集中することにしました。</p><p>構成管理として、OS内の部分はansibleを利用していたためそのまま利用し、インフラの構成管理としては、ちょうど <a href=https://sacloud.github.io/terraform-provider-sakuracloud/>Terraform for さくらのクラウド</a> もあったため、terraformを利用することにしました。</p><p>差分の検知としては、terraform plan, ansible check mode を定期的に実行することにしました。</p><h2 id=terraform-導入のために>terraform 導入のために</h2><h3 id=terraform-のフォルダ構成>terraform のフォルダ構成</h3><p><a href=https://github.com/hashicorp/best-practices/tree/master/terraform>他のクラウドでのベストプラクティス</a> を参考に、フォルダ構成は以下のようにしています。
terraform plan, apply などする場合には、 <code>pod-xxx</code> ディレクトリ配下で実行します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── module
</span></span><span style=display:flex><span>│   └── sakuracloud
</span></span><span style=display:flex><span>│       ├── compute
</span></span><span style=display:flex><span>│       │   ├── compute.tf          // compute のエントリーポイント。各roleのモジュールへ変数を渡す
</span></span><span style=display:flex><span>│       │   ├── role-hoge           // role ごとに作成
</span></span><span style=display:flex><span>│       │   │   └── role-hoge.tf    // util の base-wrapperへ変数を渡す。role固有の変数変換はここでやる
</span></span><span style=display:flex><span>│       │   └── util                // 他のroleから読まれる
</span></span><span style=display:flex><span>│       │       ├── base-wrapper    // instance と service-dns を呼ぶためのやつ。他のroleからはこいつを見る
</span></span><span style=display:flex><span>│       │       ├── instance        // 個別のサーバーの、サーバー/ディスク/DNSレコードの作成
</span></span><span style=display:flex><span>│       │       └── service-dns     // roleごとに、DNSレコードがある場合(VIPに紐づくレコードなど)
</span></span><span style=display:flex><span>│       ├── dns                     // さくらのクラウドのドメイン/DNSレコードを管理するために利用
</span></span><span style=display:flex><span>│       │   ├── dns.tf
</span></span><span style=display:flex><span>│       │   └── example
</span></span><span style=display:flex><span>│       │       ├── example.tf
</span></span><span style=display:flex><span>│       │       └── output.tf
</span></span><span style=display:flex><span>│       ├── gslb                    // さくらのクラウドのGSLBを管理するために利用
</span></span><span style=display:flex><span>│       │   ├── api
</span></span><span style=display:flex><span>│       │   │   └── api.tf
</span></span><span style=display:flex><span>│       │   └── gslb.tf
</span></span><span style=display:flex><span>│       ├── network                 // さくらのクラウドのスイッチ/ルーターを管理するために利用
</span></span><span style=display:flex><span>│       │   ├── internal
</span></span><span style=display:flex><span>│       │   │   ├── internal.tf
</span></span><span style=display:flex><span>│       │   │   └── output.tf
</span></span><span style=display:flex><span>│       │   ├── network.tf
</span></span><span style=display:flex><span>│       │   └── output.tf
</span></span><span style=display:flex><span>│       └── simple-monitor          // さくらのクラウドのシンプル監視を管理するために利用
</span></span><span style=display:flex><span>│           └── simple_monitor.tf
</span></span><span style=display:flex><span>└── providers
</span></span><span style=display:flex><span>    └── sakuracloud
</span></span><span style=display:flex><span>        └── pod-xxx                 // システム単位ごとに作る
</span></span><span style=display:flex><span>            ├── pod-xxx.tf          // compute.tf, dns.tf, ... などのモジュールごとのエントリーポイントへ変数を渡す
</span></span><span style=display:flex><span>            ├── terraform.tfstate.d // tfstate。env (今で言うworkspace) で本番と検証環境をわけてる。
</span></span><span style=display:flex><span>            │   ├── dev
</span></span><span style=display:flex><span>            │   └── ...
</span></span><span style=display:flex><span>            └── terraform.tfvars    // 変数をひたすら書く。具体的な値は全てここに書かれているはず。
</span></span></code></pre></div><p>大体はさくらのクラウドのコンポーネントごとに、moduleを作っているのですが、compute のところは大きく変更しています。
サーバー作成と同時に、ディスクの作成や、DNSレコードの作成を行うためです。</p><p>例えば、role-hoge というロールが2台あるとき、tfvar中では以下のような変数を作っています。</p><pre tabindex=0><code>sakuracloud_dns_foo = {
  dev.zone = &#34;dev.example.com&#34;
  staging.zone = &#34;staging.example.com&#34;
}

sakuracloud_role_hoge = {
  dev.ipaddresses = [&#34;192.168.0.10&#34;, &#34;192.168.0.11&#34;]
  dev.server_tags = [&#34;hoge&#34;, &#34;develop&#34;, &#34;__with_sacloud_inventory&#34;, &#34;starred&#34;]
  dev.disk_tags = [&#34;hoge&#34;]
  staging.ipaddresses = [&#34;192.168.1.10&#34;, &#34;192.168.1.11&#34;]
  staging.server_tags = [&#34;hoge&#34;, &#34;staging&#34;, &#34;__with_sacloud_inventory&#34;, &#34;starred&#34;]
  staging.disk_tags = [&#34;hoge&#34;]
</code></pre><p>これを使って、dev環境でサーバー作成したとき</p><ul><li>サーバー名をFQDNに一致させる<ul><li><code>hoge-01.dev.example.com</code>, <code>hoge-02.dev.example.com</code></li></ul></li><li>DNSレコードも合わせて作成する<ul><li>Aレコードとして <code>hoge-01.dev.example.com</code> は192.168.0.10, <code>hoge-02.dev.example.com</code> は192.168.0.11 に対応させる</li></ul></li><li>サーバータグとして、ansibleのroleをつける<ul><li><code>hoge</code>, <code>develop</code>, <code>staging</code> がansible側で利用しているロール名です</li></ul></li><li>サーバータグとして、 <code>__with_sacloud_inventory</code> をつける<ul><li>一応、terraform 管理外のリソースを許すためにつけています</li></ul></li><li>サーバータグとして、 <code>@group=a</code> などのグループタグをつける<ul><li>1つ目のサーバーはa、2つ目はb、&mldr;4つ目はd、5つ目はaなどとしています</li></ul></li></ul><h3 id=既存リソースをterraformにimport>既存リソースをterraformにimport</h3><p>既存のリソースをインポートします。形式としては、以下のような形式です。</p><pre tabindex=0><code>terraform import &#39;module.hoge.module.base-instance.sakuracloud_server.base[0]&#39; _リソースID_
</code></pre><p>注意点としては、tfファイルを書いたあと、terraform planすれば、何をインポートしないといけないかわかるのですが、
その表示では、<code>module.hoge.base-instance.sakuracloud_server.base[0]</code> というように、途中にmoduleがない形式で表示されます。 import するには都度moduleを書く必要があります。</p><p>また、さくらのクラウドにはリソースIDがないけど、terraform で管理できるものがあります。例えばDNSレコードがそうです。
この場合、リソースIDに当たるものを自分で作成する必要があります。
どのように生成するかは、 terraform for さくらのクラウドのソースを見ればよいのですが、参考までにgolangで生成する例を載せておきます。
<a href=https://play.golang.org/p/OvQw6BdxVf>https://play.golang.org/p/OvQw6BdxVf</a></p><h3 id=ansible-の-dynamic-inventory-のスクリプト作成>ansible の dynamic inventory のスクリプト作成</h3><script src=https://gist.github.com/hitsumabushi/73411a6bcb900a05c027ae0c8a39a9b3.js></script><p>上記のような<code>sacloud_inventory.py</code>スクリプトをansibleのリポジトリに実行権限をつけて用意しています。
それにより、 <code>ansible-playbook -i sacloud_inventory.py ...</code> とすることで、インベントリファイルを書くことなくansibleを実行できます。</p><p>このスクリプトで、さくらのクラウドのAPIを叩くところはすべて、 <a href=https://github.com/sacloud/usacloud>usacloud</a> におまかせしています。
先程の terraform の例であったように、 <code>__with_sacloud_inventory</code> が入っていないものは全部無視し、タグは全てグループ名にすることにしています。
(13-22行目は、<a href=https://github.com/ansible/awx>Ansible TowerのOSS版であるAWX</a> を試しているために入れています。)</p><p>もしかしたら、さくらのクラウドの特殊タグである <code>@group=a</code> などは除いた方が使いやすいかもしれませんが、監視側からも見るために現状はすべて入れています。</p><h2 id=ansible-側の準備>ansible 側の準備</h2><p><code>ansible-playbook -i sacloud_inventory.py site.yml --check</code> をしたいのですが、しばしば check modeで実行できていないplaybookや、変更がないのにchangedにしているplaybookがあります。これを直しましょう。
check modeで実行できていない、典型的なものとしては以下のようなものがあります。</p><h3 id=別のtaskの実行結果を参照している>別のtaskの実行結果を参照している</h3><p>register を使っているタスクAの結果を参照しているタスクBがある場合、check mode 中でAが実行されないため、タスクBのcheck実行時に変数が参照できないエラーが出ます。
これを防ぐには、register を使っているタスクAに <code>check_mode: no</code> をつけることです。
check modeでも本当に実行されるようになるため、例えば、ファイルの存在だけを確認している場合など、副作用がない場合のみ、 <code>check_mode: no</code> をつけましょう。</p><h3 id=check-modeに対応していない特にshellモジュール>check modeに対応していない(特にshellモジュール)</h3><p>実行する判断を行うようなタスクを作って、その結果次第で、タスクを実行するように書き換えます。
新しく作成したタスクでは、上述の通り副作用がないようにし、 <code>check_mode: no</code> をつけましょう。</p><h3 id=補足-dnsゾーンファイルの更新>補足: DNSゾーンファイルの更新</h3><p>今回、check modeで実行可能にするためにplaybookをみなしていると、ansible で更新されていないものとして、template指定されたDNSゾーンファイルがありました。
ゾーンファイルは、シリアルを増やしていく必要があるため、面倒だったのだと思います。</p><p>確かに、言われるとめんどくさいような気もしますが、やってみると以下のようにすれば良さそうです。</p><ol><li>現在のzone fileを見て、現在の serial を取り出し、registerで変数に入れる</li><li>template ファイルに、 1.で取ったserialを入れて、差分があるかどうかを確かめる</li><li>もし、2.で差分があったら serialをインクリメントした上で、template を実行する</li></ol><p>実際に書いてみると以下のようになると思います。(NSDを利用した場合の例)</p><pre tabindex=0><code>server:
    port: 10053
    zonesdir: &#34;/etc/nsd/zones&#34;

{% for zone in dns.zones %}
zone:
    name: &#34;{{ zone }}&#34;
    zonefile: &#34;{{ zone }}&#34;

{% endfor %}
</code></pre><pre tabindex=0><code>- block:
  - name: parse serial from zone file
    shell: grep &#34;;Serial&#34; /etc/nsd/zones/{{ item }} | awk &#39;{print $1}&#39;
    with_items: &#34;{{ dns.zones }}&#34;
    register: old_serials
    check_mode: no
    changed_when: no
    tags: nsd
  - name: check whether zone files updated or not
    template: src=zones/{{ item.1 }}.j2 dest=/etc/nsd/zones/{{ item.1 }} owner=root group=root mode=0644
    vars:
      serial: &#34;{{ old_serials.results[item.0].stdout }}&#34;
    with_indexed_items: &#34;{{ dns.zones }}&#34;
    diff: no
    register: zonefiles_changed
    tags: nsd
  - name: update zonefile when changed
    template: src=zones/{{ item.1 }}.j2 dest=/etc/nsd/zones/{{ item.1 }} owner=root group=root mode=0644
    vars:
      serial: &#34;{{ old_serials.results[item.0].stdout|int + 1 }}&#34;
    when: zonefiles_changed.results[item.0].changed
    with_indexed_items: &#34;{{ dns.zones }}&#34;
    notify: reload nsd
    tags: nsd
</code></pre><h2 id=定期的な差分チェック>定期的な差分チェック</h2><p>ここまでくれば、あとはcronなりJenkinsで、<code>terraform plan</code> と <code>ansible-playbook -i sacloud_inventory.py site.yml --check</code> を定期的に走らせて、差分があったらslackなりに通知すればオッケーです。
Jenkinsからapplyするようにしておけば、より良いと思います。</p><h2 id=感想と今後に向けて>感想と今後に向けて</h2><p>ここではインフラのデプロイをどのように改善してきたのかを書きました。
usacloud や Terraform for さくらのクラウドがあるおかげで、規模が大きくなっても楽に管理できている実感があります。
実際、雑に自前スクリプトを書いていたものも捨てていっているところです。</p><p>この記事で書いたようにインフラの整合性を確かめることができるようになったので、今後としては、</p><ul><li>(ansibleの実行を <a href=https://github.com/ansible/awx>AWX</a> で行う(だいたいできた) )</li><li>インフラ/アプリケーションのCDを行うための監視改善。特に node/service discovery改善</li><li>アプリケーションのCD</li><li>terraform, ansible の自動適用
などを目標に改善活動を行っていく予定です。</li></ul><hr><ul class=pager><li class=previous><a href=/post/2017/2001/ data-toggle=tooltip data-placement=top title="Mesos の sandbox のログローテーションをする">&larr;
Previous Post</a></li><li class=next><a href=/post/2018/2009/ data-toggle=tooltip data-placement=top title="Google Cloud Pub/Sub をGolangから使おうとしてハマったことまとめ">Next
Post &rarr;</a></li></ul><div id=disqus-comment></div><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hitsumabushi.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags><a href=/tags/debian title=debian>debian
</a><a href=/tags/vcp title=vcp>vcp
</a><a href=/tags/vmware title=vmware>vmware</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=https://x.com/_hitsumabushi_><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/hitsumabushi><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href rel=alternate type=application/rss+xml title=ひつまぶし食べたい><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; ひつまぶし食べたい 2024</p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>